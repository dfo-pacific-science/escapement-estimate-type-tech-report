`r if(knitr:::is_latex_output()) '% begin csasdown appendix'`
`r if(!knitr:::is_latex_output()) '# (APPENDIX) Appendix {-}'`

`r if (knitr::is_latex_output()) "\\\\clearpage"`

# Appendix A: Downgrade criteria codes {#app:downgrade-codes}

```{r downgrade-codes}
downgrade_codes <- data.frame(
  Code = c(
    "RUN_COVERAGE",
    "VISITS",
    "BREACH_BYPASS",
    "UPTIME",
    "REVIEW_QA",
    "VISIBILITY",
    "REACH_COVERAGE",
    "TIMING",
    "EFF_STD",
    "XSEC_COVERAGE",
    "CLASSIFICATION",
    "TRAP_EFF",
    "DETECTABILITY",
    "DEVICE_CONFIG",
    "ENV_COND",
    "MR_ASSUMP",
    "INFILL_METHOD",
    "DOC",
    "PRECISION_ACCURACY",
    "METHOD_UNKNOWN"
  ),
  Description = c(
    "Run window coverage gaps (missed start or end of run).",
    "Too few site visits for the claimed precision tier.",
    "Bypass or breach risk at a counting site.",
    "Device outages or unobserved intervals.",
    "Insufficient review of automated events.",
    "Poor visibility or lighting limits detection.",
    "Intended reaches or segments not surveyed.",
    "Visits not aligned with migration peak or plateau.",
    "Inconsistent effort standardization.",
    "Partial cross-section coverage.",
    "Species or target classification error.",
    "Unmeasured or uncertain trap efficiency.",
    "Redd or carcass detectability bias.",
    "Device settings not documented or unstable.",
    "Environmental conditions bias detection.",
    "Mark-recapture assumption violations.",
    "Interpolation or infilling not documented.",
    "Documentation or evidence missing.",
    "Precision or accuracy weaker than candidate Type.",
    "Survey or analysis method not identified."
  ),
  check.names = FALSE
)

csas_kable(
  downgrade_codes,
  escape = TRUE,
  bold_header = FALSE,
  font_size = 9,
  align = c("l", "l"),
  caption = "Downgrade criteria codes used by the classification key."
) |>
  csas_colspec(1, width = "4.0cm") |>
  csas_colspec(2, width = "11.0cm")
```

`r if (knitr::is_latex_output()) "\\\\clearpage"`

# Appendix B: Glossary {#app:glossary}

```{r glossary-table}
glossary <- data.frame(
  Term = c(
    "Estimate type",
    "Enumeration method",
    "Estimation method",
    "AUC (area under the curve)",
    "Method family",
    "Relative abundance",
    "WSP (Wild Salmon Policy)",
    "Breach/bypass",
    "Infilling/interpolation",
    "Calibration",
    "Downgrade flag",
    "CV (coefficient of variation)",
    "SE (standard error)"
  ),
  Definition = c(
    "A categorical data-quality class (Types 1-6) intended to summarize reliability and interpretability of an escapement estimate.",
    "The field observation approach used to collect escapement information (e.g., fixed-site counts, visual surveys, sonar detections).",
    "The analytical procedure used to convert field observations into an annual estimate (e.g., mark-recapture, AUC, modelling, expansions).",
    "A method that integrates repeated counts over time to estimate total passage or spawner abundance, typically requiring assumptions about residence time and detectability.",
    "A grouped survey/estimation class used to scope which property checks apply in the decision key (FS, V, A, S, T, R, P, M).",
    "A time-series property indicating values are comparable within the same program/method over time, but may not represent a complete census of true abundance.",
    "A Canadian policy framework that includes rapid status assessments using benchmarks and decision-tree logic applied to salmon Conservation Units.",
    "Fish bypassing a counting site, or a breach/failure of the counting installation, resulting in missed fish unless corrected.",
    "A documented method used to estimate unobserved portions of a run due to missed visits or device outages.",
    "A procedure that adjusts or infers estimates using a relationship to a higher-quality series or method, potentially changing historical values.",
    "A recorded code explaining why an estimate cannot attain a higher-quality type (e.g., VISITS, TIMING, DOC).",
    "A standardized uncertainty metric defined as the standard deviation divided by the mean (often reported as a percentage).",
    "A measure of uncertainty in an estimated quantity; commonly the standard deviation of an estimator under repeated sampling."
  ),
  check.names = FALSE
)

csas_kable(
  glossary,
  escape = TRUE,
  bold_header = FALSE,
  font_size = 9,
  align = c("l", "l"),
  caption = "Glossary of key terms used in the updated estimate-type guidance."
) |>
  csas_colspec(1, width = "4.0cm") |>
  csas_colspec(2, width = "11.0cm")
```

`r if (knitr::is_latex_output()) "\\\\clearpage"`

# Appendix C: NuSEDS data dictionary crosswalk {#app:nuseds-crosswalk}

This appendix documents how the updated guidance relates to NuSEDS fields and controlled vocabularies (see `docs/context/Data_Dictionary_NuSEDS_EN.csv`).

## C.1 Enumeration method values (ENUMERATION_METHODS)

```{r nuseds-enum-crosswalk}
dd_path <- file.path("docs", "context", "Data_Dictionary_NuSEDS_EN.csv")
dd_available <- file.exists(dd_path)

if (!dd_available) {
  dd <- NULL
  knitr::asis_output(
    "NuSEDS data dictionary CSV not present in this repo. Add it at `docs/context/Data_Dictionary_NuSEDS_EN.csv` to generate the crosswalk tables in Appendix C."
  )
} else {
  dd <- read.csv(
    dd_path,
    stringsAsFactors = FALSE,
    check.names = FALSE,
    fileEncoding = "latin1"
  )

  enum_def <- dd[["Field Definition"]][dd[["Field Name"]] == "ENUMERATION_METHODS"]
  enum_vals <- trimws(strsplit(sub(".*Values are:", "", enum_def), ",")[[1]])
  enum_vals <- sub("\\.$", "", enum_vals)

enum_crosswalk <- data.frame(
  `NuSEDS ENUMERATION_METHODS value` = enum_vals,
  `Suggested method family` = NA_character_,
  Notes = "",
  check.names = FALSE
)

enum_crosswalk[["Suggested method family"]][enum_crosswalk[[1]] %in% c(
  "Bank Walk", "Stream Walk", "Walk", "Boat", "Float", "Snorkel", "Strip Counts",
  "Spot Checks", "Dead Pitch", "Peak Live and Dead Count"
)] <- "V"
enum_crosswalk[["Suggested method family"]][enum_crosswalk[[1]] %in% c(
  "Fence", "Electronic Counters", "Enumeration by Hatchery", "Broodstock Removal"
)] <- "FS"
enum_crosswalk[["Suggested method family"]][enum_crosswalk[[1]] %in% c(
  "Fixed Wing Aircraft", "Helicopter"
)] <- "A"
enum_crosswalk[["Suggested method family"]][enum_crosswalk[[1]] %in% c(
  "Hydroacoustic Station"
)] <- "S"
enum_crosswalk[["Suggested method family"]][enum_crosswalk[[1]] %in% c(
  "Trap"
)] <- "T"
enum_crosswalk[["Suggested method family"]][enum_crosswalk[[1]] %in% c(
  "Redd Counts"
)] <- "R"
enum_crosswalk[["Suggested method family"]][enum_crosswalk[[1]] %in% c(
  "Electroshocking"
)] <- "P"
enum_crosswalk[["Suggested method family"]][enum_crosswalk[[1]] %in% c(
  "Tag Recovery"
)] <- "M"
enum_crosswalk[["Suggested method family"]][enum_crosswalk[[1]] %in% c(
  "Based on Angling Catch"
)] <- "P"
enum_crosswalk[["Suggested method family"]][enum_crosswalk[[1]] %in% c(
  "Biologist/Working Group", "Other"
)] <- "unknown"

enum_crosswalk[["Notes"]][enum_crosswalk[[1]] == "Peak Live and Dead Count"] <-
  "Value is analysis-like; prefer capturing peak/cumulative variants under ESTIMATE_METHOD."
enum_crosswalk[["Notes"]][enum_crosswalk[[1]] == "Dead Pitch"] <-
  "Carcass-based visual surveys; often paired with peak/cumulative dead estimation methods."
enum_crosswalk[["Notes"]][enum_crosswalk[[1]] == "Trap"] <-
  "If trap is non-spanning or efficiency-corrected, use T; fully constraining traps may behave more like fixed-site counting."
enum_crosswalk[["Notes"]][enum_crosswalk[[1]] == "Based on Angling Catch"] <-
  "Catch-based index; treat as a CPUE-style index unless more detail is provided."
enum_crosswalk[["Notes"]][enum_crosswalk[[1]] == "Biologist/Working Group"] <-
  "Not a method; treat as method-unknown unless a specific field/analysis method is documented elsewhere."
enum_crosswalk[["Notes"]][enum_crosswalk[[1]] == "Other"] <-
  "Treat as method-unknown unless a specific field/analysis method is documented elsewhere."

csas_kable(
  enum_crosswalk,
  escape = TRUE,
  bold_header = FALSE,
  font_size = 8,
  align = c("l", "c", "l"),
  caption = "Suggested mapping from NuSEDS enumeration method values to the updated key method families (FS, V, A, S, T, R, P, M)."
) |>
  csas_colspec(1, width = "5.0cm") |>
  csas_colspec(2, width = "1.5cm") |>
  csas_colspec(3, width = "8.0cm")
}
```

## C.2 Estimate method values (ESTIMATE_METHOD)

```{r nuseds-estimate-method-crosswalk}
if (!exists("dd_available") || !isTRUE(dd_available)) {
  knitr::asis_output(
    "NuSEDS data dictionary CSV not present in this repo. Add it at `docs/context/Data_Dictionary_NuSEDS_EN.csv` to generate the crosswalk tables in Appendix C."
  )
} else {
est_def <- dd[["Field Definition"]][dd[["Field Name"]] == "ESTIMATE_METHOD"]
est_lines <- unlist(strsplit(est_def, "\\n"))
est_lines <- trimws(est_lines)
est_lines <- est_lines[est_lines != "" & !grepl("There are several standard methods", est_lines)]
est_names <- trimws(sub(" - .*?$", "", est_lines))

est_crosswalk <- data.frame(
  `NuSEDS ESTIMATE_METHOD value` = est_names,
  `Guidance interpretation` = NA_character_,
  `Suggested method family` = NA_character_,
  Notes = "",
  check.names = FALSE
)

est_crosswalk[["Guidance interpretation"]][est_crosswalk[[1]] %in% c(
  "Fixed Site Census", "Resistivity Counter", "Video Counter"
)] <- "Enumeration device/mode (often stored as estimate method)"
est_crosswalk[["Suggested method family"]][est_crosswalk[[1]] %in% c(
  "Fixed Site Census", "Resistivity Counter", "Video Counter"
)] <- "FS"

est_crosswalk[["Guidance interpretation"]][est_crosswalk[[1]] %in% c(
  "Sonar-ARIS", "Sonar-DIDSON"
)] <- "Hydroacoustic modelling pipeline"
est_crosswalk[["Suggested method family"]][est_crosswalk[[1]] %in% c(
  "Sonar-ARIS", "Sonar-DIDSON"
)] <- "S"

est_crosswalk[["Guidance interpretation"]][est_crosswalk[[1]] %in% c(
  "Mark & Recapture: Petersen",
  "Mark & Recapture: Jolly-Seber",
  "Mark & Recapture: Bayesian",
  "Mark & Recapture: Open Model"
)] <- "Mark-recapture estimation"
est_crosswalk[["Suggested method family"]][est_crosswalk[[1]] %in% c(
  "Mark & Recapture: Petersen",
  "Mark & Recapture: Jolly-Seber",
  "Mark & Recapture: Bayesian",
  "Mark & Recapture: Open Model"
)] <- "M"

est_crosswalk[["Guidance interpretation"]][est_crosswalk[[1]] %in% c(
  "Area Under the Curve",
  "Peak Live + Dead",
  "Peak Live + Cumulative Dead",
  "(Peak Live+Cum Dead)*Expansion",
  "Peak Live * Expansion"
)] <- "Visual-series estimation (AUC/peak variants and expansions)"
est_crosswalk[["Suggested method family"]][est_crosswalk[[1]] %in% c(
  "Area Under the Curve",
  "Peak Live + Dead",
  "Peak Live + Cumulative Dead",
  "(Peak Live+Cum Dead)*Expansion",
  "Peak Live * Expansion"
)] <- "V"

est_crosswalk[["Guidance interpretation"]][est_crosswalk[[1]] %in% c("Redd Count")] <-
  "Redd-based estimation (often requires spawners-per-redd conversion)"
est_crosswalk[["Suggested method family"]][est_crosswalk[[1]] %in% c("Redd Count")] <- "R"

est_crosswalk[["Guidance interpretation"]][est_crosswalk[[1]] %in% c("Cumulative CPUE")] <-
  "CPUE index"
est_crosswalk[["Suggested method family"]][est_crosswalk[[1]] %in% c("Cumulative CPUE")] <- "P"

est_crosswalk[["Guidance interpretation"]][est_crosswalk[[1]] %in% c(
  "Addition/Subtraction",
  "Multiplication/Division",
  "Lake Expansion"
)] <- "Math/expansion operations (depends on base method)"
est_crosswalk[["Suggested method family"]][est_crosswalk[[1]] %in% c(
  "Addition/Subtraction",
  "Multiplication/Division",
  "Lake Expansion"
)] <- "depends"

est_crosswalk[["Guidance interpretation"]][est_crosswalk[[1]] %in% c("Calibrated Time Series")] <-
  "Calibrated time series (requires calibration source + diagnostics)"
est_crosswalk[["Suggested method family"]][est_crosswalk[[1]] %in% c("Calibrated Time Series")] <- "depends"

est_crosswalk[["Guidance interpretation"]][est_crosswalk[[1]] %in% c("Combined Methods")] <-
  "Combined-method workflow (requires explicit component listing)"
est_crosswalk[["Suggested method family"]][est_crosswalk[[1]] %in% c("Combined Methods")] <- "depends"

est_crosswalk[["Guidance interpretation"]][est_crosswalk[[1]] %in% c(
  "Insufficient Information",
  "Unknown Estimate Method",
  "Other Estimate Method",
  "Not Applicable",
  "Expert Opinion"
)] <- "Method unknown/administrative label"
est_crosswalk[["Suggested method family"]][est_crosswalk[[1]] %in% c(
  "Insufficient Information",
  "Unknown Estimate Method",
  "Other Estimate Method",
  "Not Applicable",
  "Expert Opinion"
)] <- "unknown"

est_crosswalk[["Notes"]][est_crosswalk[[1]] == "Resistivity Counter"] <-
  "Enumerated as a device/mode; ensure bypass/coverage/QA metadata are captured to support Type 1/2 eligibility."
est_crosswalk[["Notes"]][est_crosswalk[[1]] == "Video Counter"] <-
  "Enumerated as a device/mode; ensure QA review rate and uptime/coverage metadata are captured."
est_crosswalk[["Notes"]][est_crosswalk[[1]] == "Calibrated Time Series"] <-
  "For interpretability, record calibration source years, diagnostics, and revision history."
est_crosswalk[["Notes"]][est_crosswalk[[1]] == "Combined Methods"] <-
  "Decompose into components (e.g., sonar + visual apportionment; fence + visual during breach) and apply conservative classification."

csas_kable(
  est_crosswalk,
  escape = TRUE,
  bold_header = FALSE,
  font_size = 8,
  align = c("l", "l", "c", "l"),
  caption = "Suggested interpretation of NuSEDS estimate method values under the updated guidance. Where 'depends' appears, additional method metadata are required to apply the key cleanly."
) |>
  csas_colspec(1, width = "3.5cm") |>
  csas_colspec(2, width = "4.5cm") |>
  csas_colspec(3, width = "1.2cm") |>
  csas_colspec(4, width = "4.5cm")
}
```

`r if(knitr:::is_latex_output()) '% end csasdown appendix'`
